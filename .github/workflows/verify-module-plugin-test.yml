# Verifies changes to the brand plugin testing workflow.
name: Verify Module Plugin Testing

on:
  push:
    branches:
      - main
      - develop
    paths:
      - '**.yml'
  pull_request:
    types: [ opened, edited, synchronize, reopened, ready_for_review ]
    paths:
      - '**.yml'

concurrency:
  group: ${{ github.workflow }}-${{ github.event_name == 'pull_request' && github.head_ref || github.sha }}
  cancel-in-progress: true

# Disable permissions for all available scopes by default.
# Any needed permissions should be configured individually for each job.
permissions: {}

jobs:
  verify-module-plugin-test:
    name: ${{ matrix.name }} (${{ format( '{0}{1}', ( ! matrix.only-module-tests && 'all tests with ' || '' ), matrix.module ) }})
    strategy:
      fail-fast: false
      matrix:
        # The brand plugins to test against.
        brand: [ 'bluehost', 'hostgator', 'web.com' ]
        # Mission-critical modules that are included in all brand plugins.
        module: [ 'activation', 'secure-passwords', 'data', 'performance' ]
        only-module-tests: [ true ]

        include:
          # Define the plugin-repo value for each brand plugin.
          - brand: 'bluehost'
            name: 'Bluehost'
            plugin-repo: 'newfold-labs/wp-plugin-bluehost'
          - brand: 'crazydomains'
            name: 'Crazy Domains'
            plugin-repo: 'newfold-labs/wp-plugin-crazy-domains'
          - brand: 'hostgator'
            name: 'HostGator'
            plugin-repo: 'newfold-labs/wp-plugin-hostgator'
          - brand: 'mojo'
            name: 'Mojo'
            plugin-repo: 'newfold-labs/wp-plugin-mojo'
          - brand: 'web.com'
            name: 'Web.com'
            plugin-repo: 'newfold-labs/wp-plugin-web'

          # Include one job for each brand plugin that runs all tests.
          - brand: 'bluehost'
            name: 'Bluehost'
            plugin-repo: 'newfold-labs/wp-plugin-bluehost'
            module: 'onboarding'
            only-module-tests: false

          - brand: 'hostgator'
            name: 'HostGator'
            plugin-repo: 'newfold-labs/wp-plugin-hostgator'
            module: 'patterns'
            only-module-tests: false

          - brand: 'web.com'
            name: 'Web.com'
            plugin-repo: 'newfold-labs/wp-plugin-web'
            module: 'coming-soon'
            only-module-tests: false

          # Include one job for each deprecated brand plugins.
          - brand: 'crazydomains'
            name: 'Crazy Domains'
            plugin-repo: 'newfold-labs/wp-plugin-crazy-domains'
            module: 'ai'
            only-module-tests: false

          - brand: 'mojo'
            name: 'Mojo'
            plugin-repo: 'newfold-labs/wp-plugin-mojo'
            module: 'notifications'
            only-module-tests: false

    uses: ./.github/workflows/module-plugin-test.yml
    with:
      plugin-repo: ${{ matrix.plugin-repo }}
      module-repo: newfold-labs/wp-module-${{ matrix.module }}
      module-branch: 'main'
      node-version: '20'
      only-module-tests: ${{ matrix.only-module-tests && true || false }}
      artifact-name: wp-module-${{ matrix.module }}

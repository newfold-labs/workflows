##
# Reusable workflow for running PHPUnit unit and Codeception wp-browser wpunit tests,
# merging code coverage, committing HTML reports to GitHub Pages, and generating coverage badges.
#
# Example usage:
#   uses: newfold-labs/workflows/.github/workflows/reusable-codecoverage.yml@main
#   with:
#     php-versions: '["7.4", "8.0", "8.1", "8.2", "8.3", "8.4"]'
#     coverage-php-version: '7.4'
#     repository-name: 'wp-module-activation'
#     minimum-coverage: 25
##
name: Reusable Code Coverage

on:
  workflow_call:
    inputs:
      php-versions:
        description: JSON array of PHP versions to test (e.g., '["7.4", "8.0", "8.1"]')
        type: string
        required: true
      coverage-php-version:
        description: The PHP version designated for generating coverage reports and badges (should be one of the php-versions)
        type: string
        required: true
      repository-name:
        description: Repository name for GitHub Pages URLs (e.g., 'wp-module-activation')
        type: string
        required: true
      minimum-coverage:
        description: Minimum coverage percentage threshold
        type: number
        default: 25
      mysql-version:
        description: MySQL version for the service container
        type: string
        default: '5.7'
    secrets:
      repo_token:
        description: GitHub token for committing to gh-pages
        required: false

jobs:

  codecoverage:
    runs-on: ubuntu-latest
    permissions:
      # Write access is needed to commit coverage reports to gh-pages branch
      # (write permission includes read access for checkout)
      contents: write
      # Write access is needed to post comments on pull requests
      pull-requests: write

    services:
      mysql:
        image: mysql:${{ inputs.mysql-version }}
        env: # These are the same username and password as the wp-env container defaults
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: tests-wordpress
        ports: # This mapping matches the .wp-env.json configuration
          - 33306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    strategy:
      matrix:
        php: ${{ fromJson(inputs.php-versions) }}

    steps:

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0 # attempting to get all branch names.

      # TODO: a DEPLOY_KEY is needed to enable gh-pages for the first time (the branch can be created and pushed but
      # it will not be reachable as a website).
      # Consider @see https://github.com/peaceiris/actions-gh-pages
      #      - name: Check does gh-pages branch need to be created
      #        run: |
      #          git branch -l;
      #          if [[ $(git branch -l gh-pages) == "" ]]; then
      #            gh_pages_branch_needed=true;
      #            echo "gh-pages branch is needed";
      #          else
      #            gh_pages_branch_needed=false
      #            echo "gh-pages branch already exists";
      #          fi
      #          echo "GH_PAGES_BRANCH_NEEDED=$gh_pages_branch_needed" >> $GITHUB_ENV;
      #          mkdir gh-pages
      #
      #      - name:  Maybe create gh-pages branch
      #        if: ${{ env.GH_PAGES_BRANCH_NEEDED }}
      #        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e # v4.0.0
      #        with:
      #          github_token: ${{ secrets.GITHUB_TOKEN }}
      #          publish_dir: ./gh-pages
      #          force_orphan: true
      #          allow_empty_commit: true
      #          commit_message: "ðŸ¤– Creating gh-pages branch"

      - name: Checkout GitHub Pages branch for code coverage report
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: gh-pages
          path: gh-pages

      - name: Install PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # v2.36.0
        with:
          php-version: ${{ matrix.php }}
          coverage: xdebug
          tools: composer, jaschilz/php-coverage-badger
          extensions: zip

      - name: Check for .env.testing.example
        id: check-env-testing-example
        run: |
          if [ -f ".env.testing.example" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Setup test environment
        if: ${{ steps.check-env-testing-example.outputs.exists == 'true' }}
        run: cp .env.testing.example .env.testing

      - name: Read .env.testing
        if: ${{ steps.check-env-testing-example.outputs.exists == 'true' }}
        uses: c-py/action-dotenv-to-setenv@925b5d99a3f1e4bd7b4e9928be4e2491e29891d9 # v5
        with:
          env-file: .env.testing

      - name: Run composer install
        run: composer install -v

      - name: Check if wp-content directory exists
        id: check-wp-content
        run: |
          if [ -d "wp-content" ]; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Allow writing to wp-content
        if: ${{ steps.check-wp-content.outputs.exists == 'true' }}
        run: sudo chmod -R a+w wp-content

      # On main, there will be a previous coverage report. On PRs we create a new directory using the commit SHA.
      - name: Clear previous code coverage
        if: ${{ (github.ref == 'refs/heads/main') }}
        run: |
          rm -rf gh-pages/phpunit || true;
          mkdir gh-pages/phpunit || true;

      - name: Check if PHPUnit tests exist
        id: check-unit-tests
        run: |
          if [ -d "tests/phpunit" ] && find tests/phpunit -name '*Test.php' -type f 2>/dev/null | grep -q .; then
            echo "has_tests=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_tests=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run PHPUnit tests
        if: ${{ steps.check-unit-tests.outputs.has_tests == 'true' }}
        run: XDEBUG_MODE=coverage vendor/bin/phpunit --bootstrap tests/phpunit/bootstrap.php --coverage-php tests/_output/unit.cov --debug

      - name: Check if WPUnit tests exist
        id: check-wpunit-tests
        run: |
          if [ -d "tests/wpunit" ] && find tests/wpunit -name '*Test.php' -type f 2>/dev/null | grep -q .; then
            echo "has_tests=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_tests=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Run WPUnit tests
        if: ${{ steps.check-wpunit-tests.outputs.has_tests == 'true' }}
        run: XDEBUG_MODE=coverage vendor/bin/codecept run wpunit --coverage tests/_output/wpunit.cov --debug

      - name: Run Integration tests
        if: ${{ hashFiles('tests/integration.suite') != '' }} # Only run integration tests if they are present.
        run: XDEBUG_MODE=coverage vendor/bin/codecept run integration --debug

      # Read base (main) branch coverage from gh-pages for PR comparison. Main's coverage lives at gh-pages/phpunit/.
      # Precision: two decimals for display (matches action default). Decrease check uses integer rounding so small fluctuations don't fail.
      - name: Get base branch coverage percentage
        if: ${{ matrix.php == inputs.coverage-php-version && github.event_name == 'pull_request' }}
        id: base-coverage
        run: |
          base_pct=""
          clover="gh-pages/phpunit/clover.xml"
          if [ -f "$clover" ]; then
            # Try decimal rate first (e.g. line-rate="0.20" or statement-rate="0.20")
            rate=$(grep -oE '(line-rate|statement-rate)="[0-9.]+"' "$clover" | head -1 | sed 's/.*"\([0-9.]*\)".*/\1/')
            if [ -n "$rate" ]; then
              base_pct=$(awk "BEGIN { printf \"%.2f\", $rate * 100 }")
            else
              # Phpcov/Clover XML: each <file> has <metrics/> and project has final <metrics/> (aggregate).
              # Use last occurrence so we get project-level coverage, not the first file's (which can be 0%).
              stmts=$(grep -oP 'statements="\K[0-9]+' "$clover" | tail -1)
              covered=$(grep -oP 'coveredstatements="\K[0-9]+' "$clover" | tail -1)
              if [ -n "$stmts" ] && [ -n "$covered" ] && [ "$stmts" -gt 0 ]; then
                base_pct=$(awk "BEGIN { printf \"%.2f\", ($covered / $stmts) * 100 }")
              fi
            fi
          fi
          echo "base_coverage=${base_pct}" >> "$GITHUB_OUTPUT"

      # For PRs, we'll generate the coverage report on each pushed commit
      - name: Merge code coverage for PR
        if: ${{ matrix.php == inputs.coverage-php-version && github.event_name == 'pull_request' }}
        run: |
          vendor/bin/phpcov merge --clover clover.xml tests/_output/;
          vendor/bin/phpcov merge --clover gh-pages/${{ github.event.pull_request.head.sha }}/phpunit/clover.xml --php gh-pages/${{ github.event.pull_request.head.sha }}/phpunit/phpunit.cov --html gh-pages/${{ github.event.pull_request.head.sha }}/phpunit/html/ tests/_output/;

      # On main, we want it output to a different path
      - name: Merge code coverage for main
        if: ${{ (matrix.php == inputs.coverage-php-version) && (github.ref == 'refs/heads/main') }}
        run: |
          vendor/bin/phpcov merge --clover clover.xml tests/_output/;
          vendor/bin/phpcov merge --clover gh-pages/phpunit/clover.xml --php gh-pages/phpunit/phpunit.cov --html gh-pages/phpunit/html/ tests/_output/;

      # PR coverage percentage. Uses action default rounded-precision (2 decimals). Output coverage-rounded is used for comment, commit message, and decrease check.
      - name: Check test coverage
        if: ${{ matrix.php == inputs.coverage-php-version }}
        uses: johanvanhelden/gha-clover-test-coverage-check@2543c79a701f179bd63aa14c16c6938c509b2cec # v1
        id: coverage-percentage
        with:
          percentage: ${{ inputs.minimum-coverage }}
          exit: false
          filename: clover.xml

      # See: https://github.blog/2009-12-29-bypassing-jekyll-on-github-pages/
      - name: Add `.nojekyll` file so code coverage report successfully deploys to gh-pages
        if: ${{ matrix.php == inputs.coverage-php-version }}
        working-directory: gh-pages/phpunit
        run: |
          touch .nojekyll
          git add -- .nojekyll *

      - name: Update README coverage badge
        if: ${{ (matrix.php == inputs.coverage-php-version) && (github.ref == 'refs/heads/main') }} # only commit on main, on the PHP version we're using in production.
        run: php-coverage-badger clover.xml gh-pages/phpunit/coverage.svg

      - name: Generate PR coverage badge
        if: ${{ matrix.php == inputs.coverage-php-version && github.event_name == 'pull_request' }}
        run: php-coverage-badger clover.xml gh-pages/${{ github.event.pull_request.head.sha }}/phpunit/coverage.svg

      - name: Commit code coverage to gh-pages
        if: ${{ matrix.php == inputs.coverage-php-version }}
        uses: stefanzweifel/git-auto-commit-action@04702edda442b2e678b25b537cec683a1493fcb9 # v7.1.0
        with:
          repository: gh-pages
          branch: gh-pages
          commit_message: ${{ format('ðŸ¤– Save code coverage report to gh-pages {0}%', steps.coverage-percentage.outputs.coverage-rounded) }}
          commit_options: ""
        env:
          GITHUB_TOKEN: "${{ secrets.repo_token }}"

      - name: Add coverage comparison to PR comment
        if: ${{ matrix.php == inputs.coverage-php-version && github.event_name == 'pull_request' }}
        env:
          BASE_COVERAGE: ${{ steps.base-coverage.outputs.base_coverage }}
          PR_COVERAGE: ${{ steps.coverage-percentage.outputs.coverage-rounded }}
        run: |
          {
            if [ -z "$PR_COVERAGE" ]; then
              echo "**Coverage:** (no report)"
            elif [ -z "$BASE_COVERAGE" ]; then
              echo "**Coverage:** (first run) â†’ PR **${PR_COVERAGE}%**"
            else
              echo "**Coverage:** Base **${BASE_COVERAGE}%** â†’ PR **${PR_COVERAGE}%** (must not decrease)."
              # Compare rounded to integer so small fluctuations (e.g. 16.45% â†’ 16.44%) don't trigger failure
              BASE_INT=$(awk "BEGIN { print int($BASE_COVERAGE + 0.5) }" 2>/dev/null)
              PR_INT=$(awk "BEGIN { print int($PR_COVERAGE + 0.5) }" 2>/dev/null)
              if [ -n "$BASE_INT" ] && [ -n "$PR_INT" ] && [ "$PR_INT" -lt "$BASE_INT" ]; then
                echo "âŒ **Coverage decreased.**"
                echo ""
                echo "Please add unit tests for the new or changed code in this PR so coverage is maintained or improved."
              else
                echo "âœ… No decrease."
              fi
            fi
            echo ""
          } >> coverage-comment.md

      - name: Add coverage badge to PR comment
        if: ${{ matrix.php == inputs.coverage-php-version && github.event_name == 'pull_request' }}
        env:
          REPO_NAME: ${{ inputs.repository-name }}
          PR_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          {
            echo "[![Code Coverage ](https://newfold-labs.github.io/${REPO_NAME}/${PR_SHA}/phpunit/coverage.svg)](https://newfold-labs.github.io/${REPO_NAME}/${PR_SHA}/phpunit/html/)"
            echo ""
            echo ""
          } >> coverage-comment.md

      - name: Add coverage report link to PR comment
        if: ${{ matrix.php == inputs.coverage-php-version && github.event_name == 'pull_request' }}
        env:
          PR_COVERAGE: ${{ steps.coverage-percentage.outputs.coverage-rounded }}
          REPO_NAME: ${{ inputs.repository-name }}
          PR_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          {
            echo "[project coverage report ${PR_COVERAGE}%](https://newfold-labs.github.io/${REPO_NAME}/${PR_SHA}/phpunit/html/) @ ${PR_SHA}"
            echo ""
            echo ""
          } >> coverage-comment.md

      - name: Add phpcov uncovered lines report to PR comment
        if: ${{ matrix.php == inputs.coverage-php-version && github.event_name == 'pull_request' }}
        continue-on-error: true # phpcov can fail if there are no uncovered lines
        env:
          PR_SHA: ${{ github.event.pull_request.head.sha }}
        run: |
          BRANCHED_COMMIT=$(git rev-list origin..HEAD | tail -n 1)
          echo "BRANCHED_COMMIT=$BRANCHED_COMMIT"
          git diff "$BRANCHED_COMMIT"... "${PR_SHA}" > branch.diff
          cat branch.diff
          COV_FILE="./gh-pages/${PR_SHA}/phpunit/phpunit.cov"
          # Use canonical path so it matches paths stored in the coverage file (PHP realpath)
          PATH_PREFIX=$(realpath . 2>/dev/null || echo "$GITHUB_WORKSPACE")
          OUTPUT=$(vendor/bin/phpcov patch-coverage --path-prefix "$PATH_PREFIX" "$COV_FILE" branch.diff 2>&1) || true
          if echo "$OUTPUT" | grep -q "Unable to detect executable lines"; then
            # Fallback: try with empty prefix (some environments store relative paths in .cov)
            OUTPUT=$(vendor/bin/phpcov patch-coverage "$COV_FILE" branch.diff 2>&1) || true
          fi
          echo "$OUTPUT"
          echo "$OUTPUT" >> coverage-comment.md

      - name: Add coverage PR comment
        uses: mshick/add-pr-comment@b8f338c590a895d50bcbfa6c5859251edc8952fc # v2.8.2
        if: ${{ matrix.php == inputs.coverage-php-version && github.event_name == 'pull_request' }}
        continue-on-error: true # When a PR is opened by a non-member, there are no write permissions (and no access to secrets), so this step will always fail.
        with:
          message-id: coverage-report
          message-path: coverage-comment.md

      # Fail the job if PR coverage is lower than base (main) so merge is blocked until coverage is maintained or improved.
      # Comparison uses integer rounding so small fluctuations (e.g. 16.45% â†’ 16.44%) don't fail the build.
      - name: Ensure coverage does not decrease
        if: ${{ matrix.php == inputs.coverage-php-version && github.event_name == 'pull_request' }}
        env:
          BASE_COVERAGE: ${{ steps.base-coverage.outputs.base_coverage }}
          PR_COVERAGE: ${{ steps.coverage-percentage.outputs.coverage-rounded }}
        run: |
          # Only compare when both are non-empty and numeric (allow decimals, e.g. 16.45)
          case "$BASE_COVERAGE" in
            ''|*[!0-9.]*) echo "Skipping check (no base or PR coverage)."; exit 0 ;;
          esac
          case "$PR_COVERAGE" in
            ''|*[!0-9.]*) echo "Skipping check (no base or PR coverage)."; exit 0 ;;
          esac
          BASE_INT=$(awk "BEGIN { print int($BASE_COVERAGE + 0.5) }" 2>/dev/null)
          PR_INT=$(awk "BEGIN { print int($PR_COVERAGE + 0.5) }" 2>/dev/null)
          if [ -n "$BASE_INT" ] && [ -n "$PR_INT" ] && [ "$PR_INT" -lt "$BASE_INT" ]; then
            echo "::error::Coverage decreased from ${BASE_COVERAGE}% to ${PR_COVERAGE}%. PRs must not decrease code coverage. Add unit tests for the new or changed code in this PR."
            exit 1
          fi
          echo "Coverage maintained or improved (${BASE_COVERAGE}% â†’ ${PR_COVERAGE}%)."

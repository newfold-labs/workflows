##
# Reusable workflow for running PHPUnit unit and Codeception wp-browser wpunit tests,
# merging code coverage, committing HTML reports to GitHub Pages, and generating coverage badges.
#
# Example usage:
#   uses: newfold-labs/workflows/.github/workflows/reusable-codecoverage.yml@main
#   with:
#     php-versions: '["7.4", "8.0", "8.1", "8.2", "8.3", "8.4"]'
#     coverage-php-version: '7.4'
#     repository-name: 'wp-module-activation'
#     minimum-coverage: 25
##
name: Reusable Code Coverage

on:
  workflow_call:
    inputs:
      php-versions:
        description: JSON array of PHP versions to test (e.g., '["7.4", "8.0", "8.1"]')
        type: string
        required: true
      coverage-php-version:
        description: The PHP version designated for generating coverage reports and badges (should be one of the php-versions)
        type: string
        required: true
      repository-name:
        description: Repository name for GitHub Pages URLs (e.g., 'wp-module-activation')
        type: string
        required: true
      minimum-coverage:
        description: Minimum coverage percentage threshold
        type: number
        default: 25
      mysql-version:
        description: MySQL version for the service container
        type: string
        default: '5.7'
    secrets:
      repo_token:
        description: GitHub token for committing to gh-pages
        required: false

jobs:

  codecoverage:
    runs-on: ubuntu-latest
    permissions:
      # Write access is needed to commit coverage reports to gh-pages branch
      # (write permission includes read access for checkout)
      contents: write
      # Write access is needed to post comments on pull requests
      pull-requests: write

    services:
      mysql:
        image: mysql:${{ inputs.mysql-version }}
        env: # These are the same username and password as the wp-env container defaults
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: tests-wordpress
        ports: # This mapping matches the .wp-env.json configuration
          - 33306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    strategy:
      matrix:
        php: ${{ fromJson(inputs.php-versions) }}

    steps:

      - name: Checkout
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0 # attempting to get all branch names.

      # TODO: a DEPLOY_KEY is needed to enable gh-pages for the first time (the branch can be created and pushed but
      # it will not be reachable as a website).
      # Consider @see https://github.com/peaceiris/actions-gh-pages
      #      - name: Check does gh-pages branch need to be created
      #        run: |
      #          git branch -l;
      #          if [[ $(git branch -l gh-pages) == "" ]]; then
      #            gh_pages_branch_needed=true;
      #            echo "gh-pages branch is needed";
      #          else
      #            gh_pages_branch_needed=false
      #            echo "gh-pages branch already exists";
      #          fi
      #          echo "GH_PAGES_BRANCH_NEEDED=$gh_pages_branch_needed" >> $GITHUB_ENV;
      #          mkdir gh-pages
      #
      #      - name:  Maybe create gh-pages branch
      #        if: ${{ env.GH_PAGES_BRANCH_NEEDED }}
      #        uses: peaceiris/actions-gh-pages@4f9cc6602d3f66b9c108549d475ec49e8ef4d45e # v4.0.0
      #        with:
      #          github_token: ${{ secrets.GITHUB_TOKEN }}
      #          publish_dir: ./gh-pages
      #          force_orphan: true
      #          allow_empty_commit: true
      #          commit_message: "ðŸ¤– Creating gh-pages branch"

      - name: Checkout GitHub Pages branch for code coverage report
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          ref: gh-pages
          path: gh-pages

      - name: Install PHP
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # v2.36.0
        with:
          php-version: ${{ matrix.php }}
          coverage: xdebug
          tools: composer, jaschilz/php-coverage-badger
          extensions: zip

      - name: Setup test environment
        run: cp .env.testing.example .env.testing

      - name: Read .env.testing
        uses: c-py/action-dotenv-to-setenv@925b5d99a3f1e4bd7b4e9928be4e2491e29891d9 # v5
        with:
          env-file: .env.testing

      - name: Run composer install
        continue-on-error: true
        run: composer install -v

      - name: Check if wp-content directory exists
        id: check-wp-content
        run: |
          if [ -d "wp-content" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Allow writing to wp-content
        if: ${{ steps.check-wp-content.outputs.exists == 'true' }}
        run: sudo chmod -R a+w wp-content

      # On main, there will be a previous coverage report. On PRs we create a new directory using the commit SHA.
      - name: Clear previous code coverage
        if: ${{ (github.ref == 'refs/heads/main') }}
        run: |
          rm -rf gh-pages/phpunit || true;
          mkdir gh-pages/phpunit || true;

      - name: Check if unit tests exist
        id: check-unit-tests
        run: |
          if [ -d "tests/phpunit" ] && find tests/phpunit -name '*Test.php' -type f 2>/dev/null | grep -q .; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
          fi

      - name: Run unit tests
        if: ${{ steps.check-unit-tests.outputs.has_tests == 'true' }}
        run: XDEBUG_MODE=coverage vendor/bin/phpunit --bootstrap tests/phpunit/bootstrap.php --coverage-php tests/_output/unit.cov --debug

      - name: Check if wpunit tests exist
        id: check-wpunit-tests
        run: |
          if [ -d "tests/wpunit" ] && find tests/wpunit -name '*Test.php' -type f 2>/dev/null | grep -q .; then
            echo "has_tests=true" >> $GITHUB_OUTPUT
          else
            echo "has_tests=false" >> $GITHUB_OUTPUT
          fi

      - name: Run wpunit tests
        if: ${{ steps.check-wpunit-tests.outputs.has_tests == 'true' }}
        run: XDEBUG_MODE=coverage vendor/bin/codecept run wpunit --coverage tests/_output/wpunit.cov --debug

      - name: Run integration tests
        if: ${{ hashFiles('tests/integration.suite') != '' }} # Only run integration tests if they are present.
        run: XDEBUG_MODE=coverage vendor/bin/codecept run integration --debug

      # For PRs, we'll generate the coverage report on each pushed commit
      - name: Merge code coverage for PR
        if: ${{ matrix.php == inputs.coverage-php-version && github.event_name == 'pull_request' }}
        run: |
          vendor/bin/phpcov merge --clover clover.xml tests/_output/;
          vendor/bin/phpcov merge --clover gh-pages/${{ github.event.pull_request.head.sha }}/phpunit/clover.xml --php gh-pages/${{ github.event.pull_request.head.sha }}/phpunit/phpunit.cov --html gh-pages/${{ github.event.pull_request.head.sha }}/phpunit/html/ tests/_output/;

      # On main, we want it output to a different path
      - name: Merge code coverage for main
        if: ${{ (matrix.php == inputs.coverage-php-version) && (github.ref == 'refs/heads/main') }}
        run: |
          vendor/bin/phpcov merge --clover clover.xml tests/_output/;
          vendor/bin/phpcov merge --clover gh-pages/phpunit/clover.xml --php gh-pages/phpunit/phpunit.cov --html gh-pages/phpunit/html/ tests/_output/;

      # This makes the coverage percentage available in `{{ steps.coverage-percentage.outputs.coverage-rounded }}`.
      - name: Check test coverage
        if: ${{ matrix.php == inputs.coverage-php-version }}
        uses: johanvanhelden/gha-clover-test-coverage-check@2543c79a701f179bd63aa14c16c6938c509b2cec # v1
        id: coverage-percentage
        with:
          percentage: ${{ inputs.minimum-coverage }}
          exit: false
          filename: clover.xml
          rounded-precision: "0"

      # See: https://github.blog/2009-12-29-bypassing-jekyll-on-github-pages/
      - name: Add `.nojekyll` file so code coverage report successfully deploys to gh-pages
        if: ${{ matrix.php == inputs.coverage-php-version }}
        working-directory: gh-pages/phpunit
        run: |
          touch .nojekyll
          git add -- .nojekyll *

      - name: Update README coverage badge
        if: ${{ (matrix.php == inputs.coverage-php-version) && (github.ref == 'refs/heads/main') }} # only commit on main, on the PHP version we're using in production.
        run: php-coverage-badger clover.xml gh-pages/phpunit/coverage.svg

      - name: Generate PR coverage badge
        if: ${{ matrix.php == inputs.coverage-php-version && github.event_name == 'pull_request' }}
        run: php-coverage-badger clover.xml gh-pages/${{ github.event.pull_request.head.sha }}/phpunit/coverage.svg

      - name: Commit code coverage to gh-pages
        if: ${{ matrix.php == inputs.coverage-php-version }}
        uses: stefanzweifel/git-auto-commit-action@04702edda442b2e678b25b537cec683a1493fcb9 # v7.1.0
        with:
          repository: gh-pages
          branch: gh-pages
          commit_message: ${{ format('ðŸ¤– Save code coverage report to gh-pages {0}%', steps.coverage-percentage.outputs.coverage-rounded) }}
          commit_options: ""
        env:
          GITHUB_TOKEN: "${{ secrets.repo_token }}"

      - name: Add coverage badge to PR comment
        if: ${{ matrix.php == inputs.coverage-php-version && github.event_name == 'pull_request' }}
        run: |
          echo "[![Code Coverage ](https://newfold-labs.github.io/${{ inputs.repository-name }}/${{ github.event.pull_request.head.sha }}/phpunit/coverage.svg)](https://newfold-labs.github.io/${{ inputs.repository-name }}/${{ github.event.pull_request.head.sha }}/phpunit/html/)" >> coverage-comment.md
          echo "" >> coverage-comment.md
          echo "" >> coverage-comment.md

      - name: Add coverage report link to PR comment
        if: ${{ matrix.php == inputs.coverage-php-version && github.event_name == 'pull_request' }}
        run: |
          echo "${{ format('[project coverage report {0}%](https://newfold-labs.github.io/{1}/{2}/phpunit/html/) @ {3}', steps.coverage-percentage.outputs.coverage-rounded, inputs.repository-name, github.event.pull_request.head.sha, github.event.pull_request.head.sha) }}" >> coverage-comment.md
          echo "" >> coverage-comment.md
          echo "" >> coverage-comment.md

      - name: Add phpcov uncovered lines report to PR comment
        if: ${{ matrix.php == inputs.coverage-php-version && github.event_name == 'pull_request' }}
        continue-on-error: true # phpcov can fail if there are no uncovered lines
        run: |
          BRANCHED_COMMIT=$(git rev-list origin..HEAD | tail -n 1);
          echo "BRANCHED_COMMIT=$BRANCHED_COMMIT"
          git diff $BRANCHED_COMMIT...${{ github.event.pull_request.head.sha }} > branch.diff;
          cat branch.diff;
          OUTPUT=${vendor/bin/phpcov patch-coverage --path-prefix $(pwd) ./gh-pages/${{ github.event.pull_request.head.sha }}/phpunit/phpunit.cov branch.diff || true}
          echo $OUTPUT;
          echo "$OUTPUT" >> coverage-comment.md

      - name: Add coverage PR comment
        uses: mshick/add-pr-comment@b8f338c590a895d50bcbfa6c5859251edc8952fc # v2.8.2
        if: ${{ matrix.php == inputs.coverage-php-version && github.event_name == 'pull_request' }}
        continue-on-error: true # When a PR is opened by a non-member, there are no write permissions (and no access to secrets), so this step will always fail.
        with:
          message-id: coverage-report
          message-path: coverage-comment.md

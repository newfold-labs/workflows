# A reusable workflow for automating and managing translation files.
#
# By default, this workflow will attempt to translate untranslated strings using the Azure AI translation service.
#
# This workflow assumes the following:
# - The calling repository has a `i18n`, `i18n-ci-pre`, `i18n-ci-post` in the `composer.json` file.
# - If there are additional scripts that must be run when processing translations for some reason, then the
#   `package.json` file must also contain the `i18n`, `i18n-ci-pre`, and `i18n-ci-post` scripts. They should run the
#   corresponding Composer scripts, plus any other necessary scripts.
#
# Inputs:
#   text_domain (required)
#     Text domain for translation (e.g. plugin or theme slug).
#
#   run-azure-ai-translate (optional, default: true)
#     Whether to run the Azure AI translation step. Set false to only run i18n-ci-pre / i18n-ci-post and open PRs for those changes.
#
#   i18n-script-location (optional, default: 'composer')
#     Where i18n scripts are run from. Use "npm" if the repo runs i18n via package.json (e.g. @wordpress/scripts).
#
#   po-wrapwidth (optional, default: 77)
#     Line wrap width when the Python script saves PO files (gettext-style). Only used when the translate script actually writes a file; ignored when po-nowrap is true. Use to match your gettext/xgettext wrap width and reduce formatting-only diffs.
#
#   po-nowrap (optional, default: false)
#     If true, the Python script saves PO files with no line wrapping (each msgid/msgstr on one line). Reduces formatting-only diffs. Reference comments (#:) may be output as one long line (polib limitation).
#
# Secrets:
#   TRANSLATOR_API_KEY (required)
#     Azure Translator (Cognitive Services) API key for the translate script.
#
name: Reusable Translation Workflow

on:
  workflow_call:
    inputs:
      text_domain:
        description: 'Text domain for translation'
        required: true
        type: string
      run-azure-ai-translate:
        description: 'Whether to run the Azure AI translation step'
        required: false
        type: boolean
        default: true
      i18n-script-location:
        description: 'Where i18n scripts should be run from. Valid values are "composer" and "npm".'
        required: false
        type: string
        default: 'composer'
      po-wrapwidth:
        description: 'Line wrap width when saving PO files (default 77, match gettext). Ignored when po-nowrap is true.'
        required: false
        type: number
        default: 77
      po-nowrap:
        description: 'If true, do not wrap long msgid/msgstr (one line each). Reduces formatting-only diffs; refs (#:) may become one long line (polib limitation).'
        required: false
        type: boolean
        default: false

    secrets:
      TRANSLATOR_API_KEY:
        required: true

# Disable permissions for all available scopes by default.
# Any needed permissions should be configured individually for each job.
permissions: {}

env:
  PR_BRANCH_NAME: ${{ format( 'auto-translate/{0}', ( github.event_name == 'pull_request' && github.head_ref || github.ref_name ) ) }}

jobs:
  # This job works to ensure that the HEAD branch is present and up to date with the BASE branch.
  #
  # It handles the following situations:
  # - When a pull request already exists, `gh pr update branch` is run to pull in changes from BASE.
  # - When a pull request does not exist but the HEAD branch does, the HEAD branch is deleted and recreated to avoid conflicts.
  # - When both a pull request and the HEAD branch do not exist, a new fresh branch is created from BASE and published.
  #
  # If a HEAD branch for a pull request is deleted, the pull request is automatically closed.
  prepare-pr-branch:
    name: Prepare Pull Request Branch
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read
    outputs:
      pr_found: ${{ steps.check_pr.outputs.found }}

    steps:
      - name: Checkout repository
        id: checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          persist-credentials: true

      # Required. Outputs pr number or "false".
      - name: Check for an existing pull request
        id: check_pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REF_NAME: ${{ 'pull_request' == github.event_name && github.head_ref || github.ref_name }}
        run: |
          pr=$(gh pr list --state open --label 'translations' --base "$REF_NAME" --head "$PR_BRANCH_NAME" --json number --jq '.[0].number')
          if [ -n "$pr" ]; then
            echo "found=$pr" >> "$GITHUB_OUTPUT"
          else
            echo "found=false" >> "$GITHUB_OUTPUT"
          fi

      # Runs when no open translations PR exists. Outputs exists=true/false.
      - name: Check if branch already exists remotely
        id: branch_check
        if: steps.check_pr.outputs.found == 'false'
        run: |
          if git ls-remote --exit-code --heads origin "$PR_BRANCH_NAME"; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      # Runs when an open translations PR already exists.
      - name: Update the HEAD branch of a pre-existing pull request
        if: steps.check_pr.outputs.found != 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REF_NAME: ${{ 'pull_request' == github.event_name && github.head_ref || github.ref_name }}
        run: gh pr update-branch --yes || echo "::notice::No new changes in $REF_NAME."

      # Runs when no PR exists and the auto-translate branch already exists remotely.
      - name: Delete an orphaned branch with no pull request
        if: steps.check_pr.outputs.found == 'false' && steps.branch_check.outputs.exists == 'true'
        run: git push origin --delete "$PR_BRANCH_NAME"

      # Creates the auto-translate branch from the current ref so later jobs run on it.
      - name: Create a new branch with recent changes from the BASE
        id: create_branch
        run: git checkout -B "$PR_BRANCH_NAME"

      # Runs when no open translations PR exists (new branch was just created).
      - name: Publish the branch
        if: steps.check_pr.outputs.found == 'false'
        run: git push origin "$PR_BRANCH_NAME"

  # Ensures that all strings are accurately accounted for before performing any further translation steps.
  #
  # In order for missing strings to be translated, they must all be present in the POT and PO files.
  #
  # This job will:
  # - Check out the repository.
  # - Sets up PHP.
  # - Installs Composer dependencies.
  # - Sets up Node.js (if necessary).
  # - Installs npm dependencies (if necessary).
  # - Runs the `i18n-ci-pre` script to ensure that all strings are accounted for.
  # - Creates a diff file of the changes.
  # - Saves the diff file as an artifact for use in future steps.
  prepare-for-translation:
    name: Ensure the necessary components are updated
    runs-on: ubuntu-latest
    needs: [ 'prepare-pr-branch' ]
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        id: checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          ref: ${{ env.PR_BRANCH_NAME }}
          persist-credentials: false

      # Provides PHP so Composer and i18n-ci-pre can run.
      - name: Set up PHP
        id: setup_php
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # v2.36.0
        with:
          php-version: "8.0"

      # Installs Composer deps so i18n-ci-pre (and i18n-ci-post in a later job) can run.
      - name: Install Composer dependencies
        id: install_composer_deps
        uses: ramsey/composer-install@3cf229dc2919194e9e36783941438d17239e8520 # v3.1.1
        with:
          composer-options: "--no-interaction --no-progress --prefer-dist"

      # Runs when i18n-script-location is npm.
      - name: Set up Node.js
        id: setup_node
        if: inputs.i18n-script-location == 'npm'
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6.1.0
        with:
          node-version-file: '.nvmrc'

      # Runs when i18n-script-location is npm.
      - name: Install Node.js dependencies
        id: install_node_deps
        if: inputs.i18n-script-location == 'npm'
        run: npm ci

      # Required. Updates POT/PO so all strings are present before translation.
      - name: Run i18n-ci-pre scripts
        id: run_i18n_pre
        env:
          SCRIPT_LOCATION: ${{ inputs.i18n-script-location == 'npm' && 'npm' || 'composer' }}
        run: $SCRIPT_LOCATION run i18n-ci-pre

      # Required. Writes diff only when i18n-ci-pre produced changes.
      - name: Create a diff file
        id: create_diff
        run: |
          if ! git diff --quiet; then
            git diff > "$RUNNER_TEMP/updated-translations.diff"
          fi

      # Required. Uploads prepare diff for auto-translate (and process-translations when auto-translate skips translate).
      - name: Save patch as an artifact
        id: upload_patch
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: translations-${{ github.run_id }}
          path: ${{ runner.temp }}/updated-translations.diff
          retention-days: 7
          overwrite: true

  # Automatically translates untranslated strings using the Azure AI translation service.
  #
  # This job will:
  # - Check out the repository and apply the patch from the prepare-for-translation job.
  # - Set up Python and install dependencies (requests, polib).
  # - Check for untranslated strings: scan all PO files under languages/ for entries with empty msgstr.
  #   Only when at least one such entry exists:
  #   - Download the Python translation script from the workflow repository.
  #   - Translate PO and JSON files (Azure AI). PO formatting is controlled by inputs po-wrapwidth and po-nowrap.
  #   - Remove the downloaded script.
  #   - Create a new diff from the translation changes and overwrite the artifact.
  # - When no untranslated strings exist, the translate script is skipped so PO files are not rewritten,
  #   avoiding formatting-only diffs. The artifact from prepare-for-translation is left unchanged and re-uploaded.
  # - Saves the diff file as an artifact for use in process-translations and create-translation-pr.
  auto-translate-with-azure:
    name: Auto-Translate with Azure AI
    runs-on: ubuntu-latest
    needs: [ 'prepare-pr-branch', 'prepare-for-translation' ]
    if: inputs.run-azure-ai-translate
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          ref: ${{ env.PR_BRANCH_NAME }}
          persist-credentials: false

      # Required. May be empty if prepare-for-translation had no diff.
      - name: Download patch from prepare-for-translation
        id: download_patch
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # 7.0.0
        continue-on-error: true
        with:
          name: translations-${{ github.run_id }}
          path: ${{ runner.temp }}

      # Runs when download succeeded (artifact existed).
      - name: Apply the patch file
        id: apply_patch
        if: steps.download_patch.outcome == 'success'
        run: git apply "$RUNNER_TEMP/updated-translations.diff"

      # Provides Python so the untranslated check and translate script (polib, requests) can run.
      - name: Set up Python
        id: setup_python
        uses: actions/setup-python@83679a892e2d95755f2dac6acb0bfd1e9ac5d548  # v6.1.0
        with:
          python-version: '3.x'

      # Installs requests and polib for the PO scan and Azure translate script.
      - name: Install Python dependencies
        id: install_python_deps
        run: pip install requests polib

      # Required. Outputs has_empty_msgstr=true/false; controls whether translate and create-diff run.
      - name: Check for untranslated strings in PO files
        id: check_untranslated
        run: |
          if python3 -c "
          import polib
          from pathlib import Path
          for path in Path('languages').rglob('*.po'):
              po = polib.pofile(str(path))
              if any(not e.msgstr.strip() and e.msgid.strip() for e in po):
                  exit(0)
          exit(1)
          "; then
            echo "has_empty_msgstr=true" >> "$GITHUB_OUTPUT"
          else
            echo "has_empty_msgstr=false" >> "$GITHUB_OUTPUT"
          fi

      # Required (script is removed later whether or not translate ran).
      - name: Download translation script
        id: download_script
        run: curl -o "$RUNNER_TEMP/translate.py" https://raw.githubusercontent.com/newfold-labs/workflows/refs/heads/main/translations/translate.py

      # Runs when at least one PO file has an entry with empty msgstr.
      - name: Translate PO and JSON files
        id: translate
        if: steps.check_untranslated.outputs.has_empty_msgstr == 'true'
        env:
          TRANSLATOR_API_KEY: ${{ secrets.TRANSLATOR_API_KEY }}
          TEXT_DOMAIN: ${{ inputs.text_domain }}
          TRANSLATE_PO_WRAPWIDTH: ${{ inputs.po-wrapwidth }}
          TRANSLATE_PO_NOWRAP: ${{ inputs.po-nowrap }}
        run: python "$RUNNER_TEMP/translate.py"

      # Removes the downloaded script; runs whether or not translate ran.
      - name: Remove downloaded translate script
        id: remove_script
        run: rm -f "$RUNNER_TEMP/translate.py"

      # Runs when translate ran. Writes git diff so artifact has translation changes; when skipped, artifact stays prepare jobâ€™s diff.
      - name: Create a diff file
        id: create_diff
        if: steps.check_untranslated.outputs.has_empty_msgstr == 'true'
        run: |
          if ! git diff --quiet; then
            git diff > "$RUNNER_TEMP/updated-translations.diff"
          fi

      # Required. Overwrites artifact (either new diff from create-diff or existing from download-patch).
      - name: Save patch as an artifact
        id: upload_patch
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: translations-${{ github.run_id }}
          path: ${{ runner.temp }}/updated-translations.diff
          retention-days: 7
          overwrite: true

    # Runs post-translation scripts to finalize the translation updates.
    #
    # After translating strings, the PHP and JSON files need to be generated to ensure WordPress can properly display
    # any newly translated strings.
    #
    # This job will:
    # - Check out the repository.
    # - Downloads the patch file from the previous step.
    # - Applies the patch file.
    # - Sets up PHP.
    # - Installs Composer dependencies.
    # - Sets up Node.js (if necessary).
    # - Installs npm dependencies (if necessary).
    # - Runs the `i18n-ci-post` script to ensure all translated strings are available.
    # - Creates a diff file of the changes.
    # - Saves the diff file as an artifact for use in future steps.
  process-translations:
    name: Runs scripts post-translation
    runs-on: ubuntu-latest
    needs: [ 'prepare-pr-branch', 'prepare-for-translation', 'auto-translate-with-azure' ]
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        id: checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          ref: ${{ env.PR_BRANCH_NAME }}
          persist-credentials: false

      # Required. Artifact from auto-translate-with-azure (or prepare if that job only re-uploaded).
      - name: Download patch artifact
        id: download_patch
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # 7.0.0
        continue-on-error: true
        with:
          name: translations-${{ github.run_id }}
          path: ${{ runner.temp }}

      # Runs when download succeeded.
      - name: Apply the patch file
        id: apply_patch
        if: steps.download_patch.outcome == 'success'
        run: git apply "$RUNNER_TEMP/updated-translations.diff"

      # Provides PHP so Composer and i18n-ci-post can run.
      - name: Set Up PHP
        id: setup_php
        uses: shivammathur/setup-php@44454db4f0199b8b9685a5d763dc37cbf79108e1 # v2.36.0
        with:
          php-version: "8.0"

      # Installs Composer deps so i18n-ci-post can run.
      - name: Install Composer dependencies
        id: install_composer_deps
        uses: ramsey/composer-install@3cf229dc2919194e9e36783941438d17239e8520 # v3.1.1
        with:
          composer-options: "--no-interaction --no-progress --prefer-dist"

      # Runs when i18n-script-location is npm.
      - name: Set up Node.js
        id: setup_node
        if: inputs.i18n-script-location == 'npm'
        uses: actions/setup-node@395ad3262231945c25e8478fd5baf05154b1d79f  # v6.1.0
        with:
          node-version-file: '.nvmrc'

      # Runs when i18n-script-location is npm.
      - name: Install Node.js dependencies
        id: install_node_deps
        if: inputs.i18n-script-location == 'npm'
        run: npm ci

      # Runs i18n-ci-post to build MO/JSON so WordPress can use the translated strings.
      - name: Run i18n-ci-post scripts
        id: run_i18n_post
        env:
          SCRIPT_LOCATION: ${{ inputs.i18n-script-location == 'npm' && 'npm' || 'composer' }}
        run: $SCRIPT_LOCATION run i18n-ci-post

      # Stages new language files so they are included in the diff and PR.
      - name: Add any new language files
        id: add_language_files
        run: git add -A languages/

      # Captures i18n-ci-post changes (e.g. generated MO/JSON) for the artifact.
      - name: Create a diff file
        id: create_diff
        run: |
          if ! git diff --quiet; then
            git diff > "$RUNNER_TEMP/updated-translations.diff"
          else
            echo "::notice::No strings were missing from the POT or PO files."
          fi

      # Uploads the final diff so create-translation-pr can apply and commit it.
      - name: Save patch as an artifact
        id: upload_patch
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: translations-${{ github.run_id }}
          path: ${{ runner.temp }}/updated-translations.diff
          retention-days: 7
          overwrite: true

  # Manages the pull request for translation updates.
  #
  # When a pull request already exists, the new changes are pushed to the existing HEAD branch.
  #
  # This job will:
  # - Check out the repository.
  # - Downloads the patch file from the previous step.
  # - Stops the workflow run when no patch file is found.
  # - Sets up Node.js (if necessary).
  # - Applies the patch file to the HEAD branch.
  # - Configures the Git identity.
  # - Stages all changes, including new, untracked files.
  # - Commits the staged changes.
  # - Pushes the changes to the HEAD branch.
  # - Creates a new pull request or notes which one was updated.
  create-translation-pr:
    name: Create a Pull Request for Translation Updates
    runs-on: ubuntu-latest
    needs: [ 'prepare-pr-branch', 'prepare-for-translation', 'auto-translate-with-azure', 'process-translations' ]
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        id: checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8  # v6.0.1
        with:
          ref: ${{ env.PR_BRANCH_NAME }}
          persist-credentials: true

      # Required. Artifact from process-translations (final diff).
      - name: Download patch artifact
        id: download_patch
        uses: actions/download-artifact@37930b1c2abaa49bbe596cd826c3c89aef350131 # 7.0.0
        continue-on-error: true
        with:
          name: translations-${{ github.run_id }}
          path: ${{ runner.temp }}

      # Required. Outputs has_patch=true/false; later steps run only when true.
      - name: Check for patch to commit
        id: check_patch
        run: |
          if [ -s "$RUNNER_TEMP/updated-translations.diff" ]; then
            echo "has_patch=true" >> "$GITHUB_OUTPUT"
          else
            echo "::notice::There are no translation updates to commit."
            echo "has_patch=false" >> "$GITHUB_OUTPUT"
          fi

      # Runs when artifact contained a non-empty diff.
      - name: Apply the patch file
        id: apply_patch
        if: steps.check_patch.outputs.has_patch == 'true'
        run: git apply "$RUNNER_TEMP/updated-translations.diff"

      # Sets Git user for the commit; needed so push succeeds.
      - name: Configure Git identity
        id: git_config
        if: steps.check_patch.outputs.has_patch == 'true'
        run: |
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"

      # Stages all changes (patched files and new language files) for commit.
      - name: Stage changes
        id: stage
        if: steps.check_patch.outputs.has_patch == 'true'
        run: git add -A

      # Commits staged translation updates with a fixed message.
      - name: Commit changes
        id: commit
        if: steps.check_patch.outputs.has_patch == 'true'
        run: git commit -m "Apply all automated translation updates."

      # Pushes the commit to the auto-translate branch so the PR is updated or can be created.
      - name: Push changes
        id: push
        if: steps.check_patch.outputs.has_patch == 'true'
        run: git push origin "$PR_BRANCH_NAME"

      # Runs when we pushed and an open translations PR already existed.
      - name: Display updated pull request information
        id: display_pr_updated
        if: steps.check_patch.outputs.has_patch == 'true' && needs.prepare-pr-branch.outputs.pr_found != 'false'
        env:
          PR_NUMBER: ${{ needs.prepare-pr-branch.outputs.pr_found }}
        run: echo "::notice::Changes pushed to existing pull request https://github.com/${{ github.repository }}/pull/$PR_NUMBER."

      # Runs when we pushed and no open translations PR existed (create new PR).
      - name: Create Pull Request
        id: create_pr
        if: steps.check_patch.outputs.has_patch == 'true' && needs.prepare-pr-branch.outputs.pr_found == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REF_NAME: ${{ 'pull_request' == github.event_name && github.head_ref || github.ref_name }}
        run: |
          PR_BODY="$({
            echo "This pull request contains automatic translations of PO and JSON files."
            echo ""
            echo "The workflow run responsible for creating this pull request can be found [here](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})."
          })"

          PR_URL=$(gh pr create \
            --title "Updating translation files" \
            --body "$PR_BODY" \
            --base "$REF_NAME" \
            --head "$PR_BRANCH_NAME" \
            --label "translations")

          echo "::notice::Created new pull request: $PR_URL."
